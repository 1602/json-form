<!doctype html>
<head>
    <meta charset="utf-8" />
    <title>JSON Form</title>
<link href="https://fonts.googleapis.com/css?family=Libre+Franklin:400,600,700" rel="stylesheet">
<style>
.key-container .action { display: none !important }
.key-container:hover .action { display: block !important }
.key-container .action:focus { display: block !important }
</style>
</head>

<body>
    <script src="elm.js"></script>
    <script>
let editMe = null;

localStorage.editMe = JSON.stringify( {
            "type": "object",
            "properties": {
                "title": {
                    "title": "Title",
                    "type": "string",
                    "enum": [
                        "mr",
                        "miss",
                        "ms",
                        "mrs"
                    ]
                },
                "firstName": {
                    "title": "First name",
                    "type": "string",
                    "description": "First name(s) or given name(s), as specified in passport or travel document.",
                    "example": "Bob"
                },
                "middleName": {
                    "title": "Middle name",
                    "type": "string",
                    "default": "",
                    "description": "Middle name, if applicable.<br/>This will only be used on websites which provide separate entry for middle names, otherwise it will be ignored.<br/>If middle name is essential for placing order, consider appending it to <code>firstName</code>."
                },
                "lastName": {
                    "title": "Last name",
                    "type": "string",
                    "description": "Last name or surname, as specified in passport or travel document.",
                    "example": "Smith"
                },
                "dateOfBirth": {
                    "title": "Date of birth",
                    "type": "string",
                    "description": "Passenger's date of birth in YYYY-MM-DD format.",
                    "format": "date",
                    "example": "1976-01-27"
                },
                "addAdditionalLuggage": {
                    "title": "Additional luggage (items count)",
                    "type": "integer",
                    "description": "Add additional luggage",
                    "minimum": 0,
                    "maximum": 3,
                    "default": 0
                },
                "document": {
                  "title": "Travel document",
                  "type": "object",
                  "description": "Passenger ID (passport or other travel document). Automation may fail if this information is required by website, but not provided by Client.",
                  "properties": {
                    "type": {
                      "type": "string",
                      "description": "Document type.",
                      "enum": [
                        "passport"
                      ]
                    },
                    "number": {
                      "type": "string",
                      "description": "Document number.",
                      "example": "75 127001"
                    },
                    "issueDate": {
                      "title": "Issue date",
                      "type": "string",
                      "format": "date",
                      "example": "2008-01-01"
                    },
                    "expirationDate": {
                      "title": "Expiration date",
                      "type": "string",
                      "format": "date",
                      "example": "2028-01-01"
                    },
                    "issueCountryCode": {
                      "$ref": "#/domains/Generic/types/CountryCode",
                      "title": "Issuing country",
                      "description": "Code of country where the document was issued."
                    }
                  },
                  "required": [
                    "type",
                    "number",
                    "expirationDate",
                    "issueCountryCode"
                  ],
                  "additionalProperties": false
                }
            },
            "required": [
                "title",
                "firstName",
                "lastName",
                "dateOfBirth",
                "addAdditionalLuggage"
            ],
            "additionalProperties": false
        }
        , null, '    ');

try {
    editMe = localStorage.editMe ? JSON.parse(localStorage.editMe) : {}
} catch(e) {
    editMe = {};
}

let expandedNodes = null;

try {
    expandedNodes = localStorage.expandedNodes ? JSON.parse(localStorage.expandedNodes) : {}
} catch(e) {
    expandedNodes = {};
}

const elm = Elm.JsonFormApp.fullscreen({ value: editMe, expandedNodes: expandedNodes });

if (elm.ports && elm.ports.download) {
    elm.ports.download.subscribe(x => download(x));
}

elm.ports.save.subscribe(x => {
    localStorage.editMe = JSON.stringify(x, null, '    ');
});

elm.ports.expandedNodes.subscribe(([name, x]) => {
    expandedNodes[name] = x;
    localStorage.expandedNodes = JSON.stringify(expandedNodes, null, '    ');
});

function download(value) {
    const a = document.createElement('a');
    const blob = new Blob([JSON.stringify(value, null, '    ')], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    a.setAttribute('href', url);
    a.download = 'JSON Schema';
    a.click();
}

setTimeout(() => {

    document.body.addEventListener('dragstart', () => {
        // console.log('drag started');
    });
    document.body.addEventListener('dragover', e => {
        const b = e.dataTransfer.effectAllowed;
        e.dataTransfer.dropEffect = ('move' === b || 'linkMove' === b ||
                'copyMove' === b) ? 'move' : 'copy';
        // console.log('drag over');
        return cancel(e);
    });
    document.body.addEventListener('dragenter', e => {
        elm.ports.dragOver.send(true);
        return cancel(e);
    });
    document.body.addEventListener('dragleave', e => {
        elm.ports.dragOver.send(false);
        return cancel(e);
    });
    document.body.addEventListener('drop', drop);
    document.body.addEventListener('dragdrop', drop);

    function drop(e) {
        cancel(e);
        if (e.dataTransfer.types.includes('Files')) {
            const files = e.dataTransfer.files;
            elm.ports.dragOver.send(false);
            [].forEach.call(files, file => readContents(file));
        } else if (e.dataTransfer.types.includes('text/uri-list')) {
            elm.ports.dragOver.send(false);
            fetch(e.dataTransfer.getData('text/uri-list'))
                .then(x => x.text())
                .then(load);
        }
    }


    function readContents(file) {
        const reader = new FileReader();
        reader.readAsText(file);
        reader.addEventListener('loadend', () => {
            try {
                load(reader.result);
            } catch(e) {
                console.error(e);
            }
        });
    }

    function load(text) {
        const data = JSON.parse(text);
        localStorage.editMe = text;
        elm.ports.editJson.send(data);
    }

    function cancel(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        return false;
    }

    function offsetTop(el, limit) {
        if (el === limit) {
            return 0;
        } else {
            return el.offsetTop + offsetTop(el.parentNode, limit);
        }
    }
}, 100);

    </script>
</body>
